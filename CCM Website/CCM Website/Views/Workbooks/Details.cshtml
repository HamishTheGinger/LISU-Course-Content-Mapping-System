@model CCM_Website.Models.Workbook

@{
    ViewData["Title"] = $"{@Model.CourseCode} - Overview";
    ViewData["LearningPlatform"] = $"{@Model.LearningPlatform.PlatformName}";
    var learningTypes = ViewData["LearningTypes"] as List<LearningType>;
    var graduateAttributes = ViewData["GraduateAttributes"] as List<GraduateAttribute>;
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index">Home</a></li>
        <li class="breadcrumb-item"><a asp-controller="Workbooks" asp-action="Index">Workbooks</a></li>
        <li class="breadcrumb-item active" aria-current="page">Workbook Details</li>
    </ol>
    <hr />
</nav>

<!-- Main part of workbook page with buttons-->
<div class="container-fluid">
    <div class="row my-3 align-items-start">
        <div class="col-md-10">
            <h1 class="text-wrap">@Html.DisplayFor(model => model.CourseName)</h1>
            <h4 class="text-wrap">Course Leads: @Html.DisplayFor(model => model.CourseLead)</h4>
        </div>
        <div class="col-md-2 d-flex justify-content-center ">
            <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model?.WorkbookId">Edit Overview</a>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Left Column with Toggle Buttons -->
            <div class="col-md-2 left-column d-flex flex-column justify-content-center align-items-center">
                <br />
                <br />
                <button class="btn btn-primary m-3 rounded-pill active" id="time_breakdown_btn"> <span id="arrow_time_breakdown">◀</span>Student Notional Working Hours</button>
                <button class="btn btn-primary m-3 rounded-pill" id="time_breakdown_graph_btn"> <span id="arrow_time_breakdown_graph">▶</span>Time Breakdown Graph</button>
                <button class="btn btn-primary m-3 rounded-pill" id="graduate_attributes_btn"> <span id="arrow_graduate_attributes">▶</span>Graduate Attributes Table</button>
            </div>

            <!-- Center Content -->
            <div class="col-md-8 center-column d-flex align-items-center justify-content-center">
                <div id="graph-container" class="overflow-auto flex-column">

                    <div id="time-breakdown" class="show">
                        <table class="table table-bordered table-responsive w-auto">
                            <thead>
                                <tr class="bg-secondary text-center">
                                    <th class="text-white">Week</th>
                                    @foreach (var type in learningTypes ?? Enumerable.Empty<LearningType>())
                                    {
                                        <th id="@type.LearningTypeName">@type.LearningTypeName</th>
                                    }
                                    <th class="text-white">Total Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var week in Model!.Weeks ?? Enumerable.Empty<Week>())
                                {
                                    var weekData = ViewBag.TimeBreakdown != null && ViewBag.TimeBreakdown.ContainsKey(week.WeekNumber)
                                    ? ViewBag.TimeBreakdown[week.WeekNumber] as Dictionary<string, TimeSpan>
                                    : new Dictionary<string, TimeSpan>();

                                    <tr>
                                        <td class="text-center">@week.WeekNumber</td>
                                        @foreach (var type in learningTypes ?? Enumerable.Empty<LearningType>())
                                        {
                                            var timeValue = weekData!.ContainsKey(type.LearningTypeName) ? weekData[type.LearningTypeName] : TimeSpan.Zero;
                                            <td class="text-center">@timeValue.ToString(@"hh\:mm")</td>
                                        }
                                        <td class="text-center fw-bold">
                                            @{
                                                var totalTime = weekData?.Values.Aggregate(TimeSpan.Zero, (sum, next) => sum + next) ?? TimeSpan.Zero;
                                            }
                                            @totalTime.ToString(@"hh\:mm")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div id="time-breakdown-graph" class="d-none">
                        <div class="d-flex">
                            <div id="bar_chart_legend"></div>
                            <div id="bar_chart_details"></div>
                        </div>
                    </div>

                    <!-- Graduate Attributes Table -->
                    <div id="grad-attributes" style="display: block;">
                        <!-- Changed to 'block' to ensure visibility -->
                        <table class="table table-bordered table-responsive text-center">
                            <thead>
                                <tr style="background-color: #005398; color: white;">
                                    <th>Graduate Attributes</th>
                                    <th>Total Attributes</th>

                                    @foreach (var week in Model.Weeks ?? Enumerable.Empty<Week>())
                                    {
                                        <th>
                                            W @week.WeekNumber
                                            <br />
                                            <a asp-action="AssignAttributes" asp-controller="Workbooks"
                                               asp-route-weekId="@week.WeekId" class="btn btn-primary btn-sm rounded-pill m-1"
                                               style="background-color: #44546A; color: white; border: none;">
                                                Assign
                                            </a>
                                        </th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var graduateAttribute in (Model.Weeks ?? Enumerable.Empty<Week>())
                                .Where(week => week.WeekGraduateAttributes != null)
                                .SelectMany(week => week.WeekGraduateAttributes!
                                .Select(wga => wga.GraduateAttribute))
                                .Where(attr => attr != null)
                                .Distinct())
                                {
                                    <tr>
                                        <td style="text-align: center; background-color: #44546A; color: white;">
                                            @graduateAttribute.AttributeName
                                        </td>
                                        <td class="text-center">
                                            @graduateAttribute.WeekGraduateAttributes?.Count()
                                        </td>
                                        @foreach (var week in Model.Weeks ?? Enumerable.Empty<Week>())
                                        {
                                            var attributeCountForWeek = week.WeekGraduateAttributes?
                                            .Count(wga => wga.GraduateAttributeId == graduateAttribute.AttributeId) ?? 0;
                                            <td class="text-center">
                                                @attributeCountForWeek
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>


                    <div id="legend" class="d-none">
                        <table class="table table-bordered table-responsive">
                            <thead>
                            <tr><th>Legend</th></tr>
                            </thead>
                            <tbody>
                            <tr><td id="Acquisition_legend">Acquisition</td><td>Forums,Lectures,Live Webinar, Multiple-Choice Questions(MCQ), Podcasts, Q & A Walls, Readings, Videos</td></tr>
                            <tr><td id="Collaboration_legend">Collaboration</td><td>Collaborative Docs, Crowd Sourcing, Digital Artifact, Mind Mapping, Peer Review, Podcast, Shared Resource, Social Annotation, Software Dev, Video</td></tr>
                            <tr><td id="Discussion_legend">Discussion</td><td>Debates, Engaging in Dialogue, Group Discussions, Microsoft Teams, Moodle Forum, Social Annotation, Social Networking, Twitter, Webinar, Zoom </td></tr>
                            <tr><td id="Investigation_legend">Investigation</td><td>Analysing Data, Desk Research, Research using Databases, Web Search</td></tr>
                            <tr><td id="Practice_legend">Practice</td><td>Assessment Prep, Case Studies, Drafting a Paper, Multiple-Choice Questions(MCQ), Reflective Tasks, Scenarios</td></tr>
                            <tr><td id="Production_legend">Production</td><td>Annotated Bibliography, Assessment, Blogging, Case Study, Course Doc FAQ, ePortfolios, Peer Review, Podcast, Reflection, Report, Software Dev, Video, Wiki</td></tr>
                            <tr><td id="Assessment_legend" class="text-white">Assessment</td><td>Graded summative assignment that is a dedicated student activity as outlined in Coursera and the UofG PIP form</td></tr>
                            </tbody>
                        </table>

                    </div>
                    
                </div>
            </div>


            <!-- Right Column -->
            
            <div class="col-md-2 right-column d-flex flex-column align-items-center">
                @foreach (var week in @Model.Weeks ?? Enumerable.Empty<Week>())
                {
                    <a class="btn btn-primary mb-2 rounded-pill" asp-action="Week" asp-route-id="@week.WeekId">Week @week.WeekNumber</a>
                }
            </div>

            <div class="text-center d-flex justify-content-center">
                <button class="btn btn-primary m-3 rounded-pill" id="legend_btn"> <span id="arrow_legend">▲</span>Legend</button>
            </div>

        </div>
    </div>



<script>    

    //get learning type colours from database for graphs and tables
    //get list of learning types for graph
    var colourData = [];
    var activities=[];

    @foreach (var type in learningTypes ?? Enumerable.Empty<LearningType>())
    {
        
        <text>
    activities.push("@type.LearningTypeName");
    colourData.push({
        label: "@type.LearningTypeName",
        color: "@type.LearningTypeColour",
        textColor: "@type.LearningTypeTextColour",
    });
    
        
        </text>
    }
    

    
    function refocusButton(id) {

        let content = document.getElementById(`${id}`);
        content.focus();
        content.scrollIntoView({ behavior: "smooth", block: "center" });
    }
    
    // Get the sections and buttons
    function toggleSection(buttonId, sectionId, arrowId) {
        const button = document.getElementById(buttonId);
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById(arrowId);

        colourData.forEach(item => {
            const colourCell = document.getElementById(item.label);
            if (colourCell) {
                colourCell.style.backgroundColor = item.color;
                colourCell.style.color = item.textColor;
            }
        });

        button.addEventListener("click", function () {
            if (section.classList.contains("d-none")) {
                section.classList.add("show");
                section.classList.remove("d-none");
                arrow.textContent = "◀"; 
                refocusButton(sectionId);
                button.classList.add("active");
                
            } else {
                section.classList.remove("show");
                section.classList.add("d-none");
                arrow.textContent = "▶";
                button.classList.remove("active");
            }
        });
    }

    function toggleLegendSection(buttonId, sectionId, arrowId) {
        const button = document.getElementById(buttonId);
        const section = document.getElementById(sectionId);
        const arrow = document.getElementById(arrowId);

        button.addEventListener("click", function () {
            if (section.classList.contains("d-none")) {
                section.classList.add("show");
                section.classList.remove("d-none");
                arrow.textContent = "▼";
                refocusButton(sectionId);
                button.classList.add("active");

                colourData.forEach(item => {
                    const legendCell = document.getElementById(item.label + "_legend");
                    if (legendCell) {
                        legendCell.style.backgroundColor = item.color;
                        legendCell.style.color = item.textColor;
                    }
                });

            } else {
                section.classList.remove("show");
                section.classList.add("d-none");
                arrow.textContent = "▲";
                button.classList.remove("active");
            }
        });

        
    }

    // Apply toggle functionality to each button-section pair
    toggleSection("time_breakdown_btn", "time-breakdown", "arrow_time_breakdown");
    toggleSection("time_breakdown_graph_btn", "time-breakdown-graph", "arrow_time_breakdown_graph");
    toggleSection("graduate_attributes_btn", "grad-attributes", "arrow_graduate_attributes");
    toggleLegendSection("legend_btn", "legend", "arrow_legend");




    // Time breakdown graph
    const data = [
        @foreach (var week in Model.Weeks ?? Enumerable.Empty<Week>()){
            var weekData = ViewBag.TimeBreakdown[week.WeekNumber] as Dictionary<string, TimeSpan>;

            if (weekData != null) {
            @: {
                @:week: @week.WeekNumber,
                @foreach (var type in ViewBag.LearningTypes ?? Enumerable.Empty<LearningType>()){
                    @:@type.LearningTypeName.Replace(" ", ""): @weekData[type.LearningTypeName].TotalHours.ToString("0.##"),
                    }
            @: },
            }
        }
    ];


    // Step 3: Create Stacked Data Dynamically

    const stackedData = d3.stack().keys(activities)(data);

    const colorScale = d3.scaleOrdinal()
        .domain(activities)
        .range(colourData.map(d => d.color));

    const svg = d3.select("#time-breakdown-graph")
        .append("svg")
        .attr("width", 800)
        .attr("height", 400);

    const width = 800;
    const height = 400;
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };

    const xScale = d3.scaleBand()
        .domain(data.map(d => d.week))
        .range([margin.left, width - margin.right])
        .padding(0.1);

    const yScale = d3.scaleLinear()
        .domain([0, d3.max(stackedData, layer => d3.max(layer, d => d[1] || 0))]) // Fallback to 0 if d[1] is NaN
        .nice()
        .range([height - margin.bottom, margin.top]);

    const hoverValues = d3.select("#hoverValues");

    svg
        .selectAll("g")
        .data(stackedData)
        .join("g")
        .attr("fill", d => colorScale(d.key))
        .selectAll("rect")
        .data(d => d)
        .join("rect")
        .attr("x", d => xScale(d.data.week))
        .attr("y", d => yScale(d[1]))
        .attr("height", d => yScale(d[0]) - yScale(d[1]))
        .attr("width", xScale.bandwidth())
        .on("mouseover", function (event, d) {
            let activityType = d3.select(this.parentNode).datum().key;
            displayDetails(d.data, activityType);
        })
        .on("mouseout", function () {
            hideDetails();
        });

    // Add X-axis
    svg
        .append("g")
        .attr("transform", `translate(0, ${height - margin.bottom})`)
        .call(d3.axisBottom(xScale));

    // Add Y-axis
    svg
        .append("g")
        .attr("transform", `translate(${margin.left}, 0)`)
        .call(d3.axisLeft(yScale).tickFormat(d => {
            const hours = Math.floor(d);
            const minutes = Math.round((d - hours) * 60);
            return `${hours}:${minutes.toString().padStart(2, "0")}`;
        }));



    // Create a container for the legend
    const barChartLegend = d3.select("#bar_chart_legend")
        .style("display", "flex")
        .style("flex-direction", "column")
        .style("margin-left", "20px")
        .style("margin-top", "20px");

    // Populate the legend with activity names and their corresponding colors
    barChartLegend.selectAll("div")
        .data(activities)
        .enter()
        .append("div")
        .style("display", "flex")
        .style("align-items", "center")
        .style("margin-bottom", "5px")
        .html(activity => {

            console.log("Legend Activity:", activity, "Color:", colorScale(activity));
            return `
                <div style="width: 12px; height: 12px; background-color: ${colorScale(activity)}; margin-right: 8px; border: 1px solid black;"></div>
                ${activity}
            `;
        });

    function displayDetails(d, activityType) {
        let detailsDiv = d3.select("#bar_chart_details");

        let totalHours = d[activityType];

        // Convert to 00:00 format
        let hours = Math.floor(totalHours);
        let minutes = Math.round((totalHours - hours) * 60);

        detailsDiv.html(`<strong>Week ${d.week}</strong><br>${activityType}: <strong>${hours}:${minutes.toString().padStart(2, "0")}</strong>`);

        detailsDiv.style("display", "block");
    }

    function hideDetails() {
        d3.select("#bar_chart_details").style("display", "none");
    }


</script>
