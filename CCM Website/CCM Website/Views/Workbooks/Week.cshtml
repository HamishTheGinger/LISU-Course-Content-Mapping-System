@using Microsoft.AspNetCore.Mvc.TagHelpers
@model CCM_Website.ViewModels.WeekDetailsViewModel
@{
    ViewData["Title"] = $"{@Model.Week.Workbook.CourseCode} - Week {@Model.Week.WeekNumber}";
    ViewData["LearningPlatform"] = $"{@Model.Week.Workbook.LearningPlatform.PlatformName}";
    var learningLocationCounts = ViewBag.locationCount as Dictionary<string, int>;
    var taskProgressCounts = ViewBag.progressCount as Dictionary<string, int>;
    var learningTypes = ViewData["LearningTypes"] as List<LearningType>;
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index">Home</a></li>
        <li class="breadcrumb-item"><a asp-controller="Workbooks" asp-action="Index">Workbooks</a></li>
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Workbooks" asp-action="Details" asp-route-id="@Model.Week.WorkbookId">Workbook Details</a></li>
        <li class="breadcrumb-item active" aria-current="page">Week @Model.Week.WeekNumber</li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row my-3">
        <div class="col-md-10">
            <h1 class="text-wrap">@Model.Week.Workbook.CourseName</h1>
            <h4 class="text-wrap">@Model.Week.Workbook.CourseLead</h4> 
        </div>
        <div class="col-md-2 d-flex text-center justify-content-center">
            <a asp-controller="Workbooks" asp-action="CreateActivity" asp-route-id="@Model.Week.WorkbookId" asp-route-weekId="@Model.Week.WeekId" class="btn btn-primary rounded-pill text-decoration-none d-flex align-items-center h-75 p-3 m-2" >Create Activity</a>
        </div>
    </div>
    <div class="row">
        <div class="col-md-10">
            <div class="table-responsive mb-3">
                <table id="weekTable"class="table table-bordered">
                    <thead>
                    <tr>
                        <th class ="bg-week-table text-white text-center" id="weekTableHeading">Week @Model.Week.WeekNumber</th>
                    </tr>
                    <tr class="bg-week-table text-white text-center">
                        <th>@Html.DisplayName("Staff Responsible")</th>
                        <th>@Html.DisplayName("Title")</th>
                        <th>@Html.DisplayName("Learning Activity")</th>
                        <th>@Html.DisplayName("Learning Type")</th>
                        <th>@Html.DisplayName("Time (Hrs:Mins)")</th>
                        <th>@Html.DisplayName("Task Status")</th>
                        <th>@Html.DisplayName("Activity Location")</th>
                        <th>@Html.DisplayName("Learning Approach")</th>
                        <th>Change Order</th>
                        <th>Edit Activity</th>

                    </tr>
                    </thead>
                    <tbody>
      
                    </tbody>
                </table>
            </div>

            <div class="row mb-10 justify-content-around">
                <div id="legend" style="display: none">
                    <table class="table table-bordered table-responsive">
                        <thead>
                        <th>Legend</th>
                        </thead>
                        <tbody>
                        <tr><td id="Acquisition_legend">Acquisition</td><td>Forums,Lectures,Live Webinar, Multiple-Choice Questions(MCQ), Podcasts, Q&A Walls, Readings, Videos</td></tr>
                        <tr><td id="Collaboration_legend">Collaboration</td><td>Collaborative Docs, Crowd Sourcing, Digital Artifact, Mind Mapping, Peer Review, Podcast, Shared Resource, Social Annotation, Software Dev, Video</td></tr>
                        <tr><td id="Discussion_legend">Discussion</td><td>Debates, Engaging in Dialogue, Group Discussions, Microsoft Teams, Moodle Forum, Social Annotation, Social Networking, Twitter, Webinar, Zoom </td></tr>
                        <tr><td id="Investigation_legend">Investigation</td><td>Analysing Data, Desk Research, Research using Databases, Web Search</td></tr>
                        <tr><td id="Practice_legend">Practice</td><td>Assessment Prep, Case Studies, Drafting a Paper, Multiple-Choice Questions(MCQ), Reflective Tasks, Scenarios</td></tr>
                        <tr><td id="Production_legend">Production</td><td>Annotated Bibliography, Assessment, Blogging, Case Study, Course Doc FAQ, ePortfolios, Peer Review, Podcast, Reflection, Report, Software Dev, Video, Wiki</td></tr>
                        <tr><td id="Assessment_legend" class="text-white">Assessment</td><td>Graded summative assignment that is a dedicated student activity as outlined in Coursera and the UofG PIP form</td></tr>
                        </tbody>
                    </table>

                </div>

                <div class="col-md-6 d-flex flex-column justify-content-start align-items-center table-responsive">
                    <button class="btn btn-primary m-3 rounded-pill " id="lt_table_hide"> <span id="arrow_stats">▼</span> Statistics</button>

                    <div class="d-flex flex-column justify-content-center align-items-center">
                        <table id="stats_table" class="table table-bordered text-center position-sticky" style="display:block">
                            <thead>
                            <tr>
                                <th colspan="4" class ="text-white bg-stats-table">Statistics</th>
                            </tr>
                            <tr class ="text-white bg-stats-table">
                                <th>Learning Type</th>
                                <th>Allocation</th>
                                <th>Status</th>
                                <th>Tasks</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td id="Acquisition"></td>
                                <td id="Acquisition_data"></td>
                                <td class="bg-red">Unassigned</td>
                                <td id="Unassigned"></td>
                            </tr>
                            <tr>
                                <td id="Collaboration"></td>
                                <td id="Collaboration_data"></td>
                                <td class="bg-amber">In Progress</td>
                                <td id="InProgress"></td>
                            </tr>
                            <tr>
                                <td id="Discussion"></td>
                                <td id="Discussion_data"></td>
                                <td class="bg-green">Completed</td>
                                <td id="Completed"></td>
                            </tr>
                            <tr>
                                <td id="Investigation"></td>
                                <td id="Investigation_data"></td>
                                <td>Total Tasks</td>
                                <td id="Total" class="bg-stats-total"></td>
                            </tr>
                            <tr>
                                <td id="Practice"></td>
                                <td id="Practice_data"></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td id="Production"></td>
                                <td id="Production_data"></td>
                                <th class="bg-stats-table text-white">Activity Location</th>
                                <th class="bg-stats-table text-white">Total</th>
                            </tr>
                            <tr>
                                <td id="Assessment"></td>
                                <td id="Assessment_data"></td>
                                <td class="bg-on-campus">On Campus</td>
                                <td id="OnCampus"></td>
                            </tr> 
                            <tr>
                                <td class="fw-bold">Total Time</td>
                                <td id="TotalTime" class="fw-bold bg-stats-total"></td>
                                <td class="bg-remote">Remote (Home)</td>
                                <td id="Remote"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="col-md-6 d-flex flex-column justify-content-start align-items-center">
                    <button class="btn btn-primary m-3 rounded-pill" id="lt_chart_hide"> <span id="arrow_chart">▼</span> Chart</button>

                    <div class="d-flex flex-column justify-content-center align-items-center">
                        <div id="lt_chart" style="display:block"></div>
                        <div id="lt_chart_key" style="display:block"></div>
                        <div id="lt_chart_details" style="display:none"></div>
                    </div>

                </div>
            </div>

            <div class="text-center d-flex justify-content-center">
                <button class="btn btn-primary m-3 rounded-pill" id="legend_btn"> <span id="arrow_legend">▲</span> Legend</button>
            </div>

        </div>


        <div class="col-md-2 d-flex flex-column">
            @foreach (var week in Model.Week.Workbook.Weeks.OrderBy(w => w.WeekNumber))
            {
                <div class="d-flex justify-content-center">
                    @if (Model.Week.WeekNumber != week.WeekNumber) {
                        <a class="btn btn-primary mb-2 rounded-pill bg-secondary" asp-action="Week" asp-route-id="@week.WeekId">
                            Week @week.WeekNumber
                        </a>
                    }
                    else {
                        <a class="btn btn-primary mb-2 rounded-pill bg-gray-600 border border-gray-600" >
                            Week @week.WeekNumber
                        </a>
                    }

                </div>
            }
        </div>
    </div>


</div>
<script>
    
    //Data for the main table
    var weekTableBody = document.getElementById('weekTable').querySelector('tbody');
    var weekTableData = [];
    @foreach (var item in Model.ActivitiesList)
    {
        <text>
            weekTableData.push({
                id: "@item.WeekActivityId",
                taskOrder : "@item.TaskOrder",
                staffResponsible: "@item.TaskStaff",
                title: "@item.TaskTitle",
                learningActivity: "@item.Activities.ActivityName",
                learningType: "@item.LearningType.LearningTypeName",
                time: "@item.TaskTime.ToString(@"hh\:mm")",
                status: "@item.TasksStatus.StatusName",
                activityLocation: "@item.TaskLocation.LocationName",
                approach: "@item.TaskApproach.ApproachName"
            });
        </text>
    }
    
    //Populating the heading for the table
    var tableHeading = document.getElementById('weekTableHeading')
    tableHeading.colSpan = Object.keys(weekTableData[0]).length + 2;
    
    //Populating the table from the data
    function renderTable() {
    
        weekTableBody.innerHTML = '';
        weekTableData.forEach(function(rowData, index) {
            var row = document.createElement('tr');
            for (var key in rowData) {
                if (key !== "id" && key !== "taskOrder") {
                    var cell = document.createElement('td');
                    cell.textContent = rowData[key];
                    row.appendChild(cell);
                }
            }

            var actionCell = document.createElement('td');
            var upButton = document.createElement('button');
            upButton.textContent = "▲";
            upButton.disabled = index === 0;
            upButton.style.background = "none";
            upButton.style.border = "none";
            upButton.id = `upButton-${index}`;

            upButton.addEventListener("mouseover", function() {
                if (!upButton.disabled) {
                    upButton.style.color = "#0d6efd";
                }
            });
            upButton.addEventListener("mouseout", function() {
                upButton.style.color = "";
            });

            var downButton = document.createElement('button');
            downButton.textContent = "▼";
            downButton.style.background = "none";
            downButton.style.border = "none";
            downButton.disabled = index === weekTableData.length - 1;
            downButton.id = `downButton-${index}`;

            downButton.addEventListener("mouseover", function() {
                if (!downButton.disabled) {
                    downButton.style.color = "#0d6efd";
                }
            });
            downButton.addEventListener("mouseout", function() {
                downButton.style.color = "";
            });

            upButton.onclick = function() {
                moveRow(index, -1);
                setTimeout(() => {
                    refocusArrows(index - 1, "up");
                }, 0);
            };

            downButton.onclick = function() {
                moveRow(index, 1);
                setTimeout(() => {
                    refocusArrows(index + 1, "down");
                }, 0);
            };

            actionCell.appendChild(upButton);
            actionCell.appendChild(downButton);
            actionCell.classList.add("d-flex", "flex-column","gap-4");
            actionCell.style.border = "none";
            row.appendChild(actionCell);

            var editCell = document.createElement('td');
            var editLink = document.createElement('a');
            editLink.textContent = "Edit Activity";
            editLink.href = `/Workbooks/EditActivity/${rowData.id}`;
            editLink.className = "btn btn-primary";
            editCell.appendChild(editLink);
            row.appendChild(editCell);
            weekTableBody.appendChild(row);
        });
    }

    //Function to show changes to the order made by the user
    function moveRow(index, direction) {
        var newIndex = index + direction;
        var temp = weekTableData[index];
        weekTableData[index] = weekTableData[newIndex];
        weekTableData[newIndex] = temp;

        if (direction > 0 && weekTableData[index]) {
            upF(weekTableData[index].id);
            downF(weekTableData[newIndex].id); 
        }else{
            upF(weekTableData[newIndex].id);
            downF(weekTableData[index].id);  
        }
        renderTable();
    }

    renderTable();

    //Stats table data 
    var statsData = [];
    var unassigned = @Model.ActivitiesList.Count(a => a.TasksStatus.StatusName == "Unassigned");
    var inProgress = @Model.ActivitiesList.Count(a => a.TasksStatus.StatusName == "In-Progress");
    var completed = @Model.ActivitiesList.Count(a => a.TasksStatus.StatusName == "Completed");
    var onCampus = @Model.ActivitiesList.Count(a => a.TaskLocation.LocationName == "On Campus");
    var remote = @Model.ActivitiesList.Count(a => a.TaskLocation.LocationName == "Remote (Home)");
    var total = unassigned + inProgress + completed;
    @{
        double totalTime = Model.ActivitiesList
            .Select(a => (double?)a.TaskTime.TotalMinutes)
            .Sum() ?? 0;
    }
    
    const unassignedCell = document.getElementById("Unassigned")
    unassignedCell.textContent = unassigned;
    const inProgressCell = document.getElementById("InProgress")
    inProgressCell.textContent = inProgress;
    const completedCell = document.getElementById("Completed")
    completedCell.textContent = completed;
    const totalCell = document.getElementById("Total")
    totalCell.textContent = total;
    const onCampusCell = document.getElementById("OnCampus")
    onCampusCell.textContent = onCampus;
    const remoteCell = document.getElementById("Remote")
    remoteCell.textContent = remote;
    const totalTimeCell = document.getElementById("TotalTime")
    let hoursTotal = Math.floor(@totalTime/60);
    let minutesTotal = @totalTime%60;
    totalTimeCell.textContent = `${hoursTotal.toString().padStart(2, '0')}:${minutesTotal.toString().padStart(2, '0')}`;

    @{
        foreach (var type in learningTypes)
        {
            var time = Model.ActivitiesList
                .Where(a => a.LearningType.LearningTypeName == type.LearningTypeName)
                .Select(a => (double?)a.TaskTime.TotalMinutes)
                .Sum() ?? 0; 
            
            <text>
        statsData.push({
            label: "@type.LearningTypeName", 
            time: @time,
            color: "@type.LearningTypeColour",
            textColor: "@type.LearningTypeTextColour"
        });
    </text>
        }
    }

    //populating table
    statsData.forEach(item => {
        const labelId = item.label;
        const cell = document.getElementById(labelId);
        const cellData = document.getElementById(labelId + "_data");
        if (cell) {
            cell.textContent = item.label;
            cell.style.backgroundColor = item.color;
            cell.style.color = item.textColor;
        }
        if (cellData) {
            let hours = Math.floor(item.time/60);
            let minutes = item.time%60;
            cellData.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
    });

    //button toggle functions
    document.getElementById("lt_table_hide").addEventListener("click", toggleStatsTable);
    document.getElementById("lt_chart_hide").addEventListener("click", togglePieChart);
    document.getElementById("legend_btn").addEventListener("click", toggleLegend);

    function togglePieChart() {
        const chart = document.getElementById("lt_chart");
        const key = document.getElementById("lt_chart_key");
        const currentDisplay = chart.style.display;
        const arrow = document.getElementById("arrow_chart");
        const newDisplay = currentDisplay === "none" ? "block" : "none";
        chart.style.display = newDisplay;
        key.style.display = newDisplay;
        if (currentDisplay === "none") {
            arrow.innerHTML = "▲";
            refocusButton("lt_chart");
        } else {
            arrow.innerHTML = "▼";
        }
    }

    function toggleLegend() {
        const chart = document.getElementById("lt_chart");
        const table = document.getElementById("stats_table");
        const key = document.getElementById("lt_chart_key");
        const legend = document.getElementById("legend");
        const arrow = document.getElementById("arrow_legend");
        const buttonChart = document.getElementById("lt_chart_hide");
        const buttonTable = document.getElementById("lt_table_hide");

        const currentDisplay = legend.style.display;
        statsData.forEach(item => {
            const legend_colour = document.getElementById(item.label + "_legend");
            legend_colour.style.backgroundColor = item.color;
        });

        legend.style.display = currentDisplay === "none" || currentDisplay === "" ? "block" : "none";
        chart.style.display = "none";
        key.style.display = "none";
        table.style.display = "none";
        buttonChart.style.display = "none";
        buttonTable.style.display = "none";

        if (legend.style.display === "block") {
            arrow.innerHTML = "▼";
            refocusButton("legend");

        } else {
            arrow.innerHTML = "▲";
            buttonChart.style.display = "block";
            buttonTable.style.display = "block";
        }
    }

    function toggleStatsTable() {
        const table = document.getElementById("stats_table");
        const arrow = document.getElementById("arrow_stats");
        const currentDisplay = table.style.display;
        const newDisplay = currentDisplay === "none" ? "block" : "none";
        table.style.display = newDisplay;

        if (currentDisplay === "none") {
            arrow.innerHTML = "▲";
            refocusButton("stats_table");
        } else {
            arrow.innerHTML = "▼";
        }
    }
    
    //function to call controller to save new taskOrder to the DB
    function upF(activityId) {
        fetch('/Workbooks/activityUp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(activityId),
        })
            .catch(error => console.error('Error:', error));
    }

    function downF(activityId) {
        fetch('/Workbooks/activityDown', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(activityId),
        })
            .catch(error => console.error('Error:', error));
    }
    
    //functions to focus the screen on the related elements
    function refocusArrows(newIndex, direction) {

        if (direction === "up") {
            let upButton = document.getElementById(`upButton-${newIndex}`);
            upButton.focus();
            upButton.scrollIntoView({ behavior: "smooth", block: "center" });
        } else if (direction === "down") {
            let downButton = document.getElementById(`downButton-${newIndex}`);
            downButton.focus();
            downButton.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }

    function refocusButton(id) {

        let content = document.getElementById(`${id}`);
        content.focus();
        content.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    // Pie chart vector
    var pieMargin = 20;
    var pieWidth = Math.max(window.innerWidth * 0.2, 230);
    var pieHeight = Math.max(window.innerWidth * 0.2, 230);
    var pieRadius = Math.max(pieWidth, pieHeight) / 2 - pieMargin;

    var svg = d3.select("#lt_chart")
        .append("svg")
        .attr("width", pieWidth)
        .attr("height", pieHeight)
        .append("g")
        .attr("transform", "translate(" + pieWidth / 2 + "," + pieHeight / 2 + ")");

    var color = d3.scaleOrdinal()
        .domain(statsData.map(d => d.label))
        .range(statsData.map(d => d.color));

    var pie = d3.pie()
        .value(function(d) { return d.time; });

    var arc = d3.arc()
        .innerRadius(0)
        .outerRadius(pieRadius);

    // Draw Pie Slices
    svg.selectAll('path')
        .data(pie(statsData))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', function(d) { return color(d.data.label); })
        .attr("stroke", "black")
        .style("stroke-width", "0px") 
        .style("opacity", 1)
        .on("mouseover", function (event, d) {
            displayDetails(d.data);
        })
        .on("mouseout", function () {
            hideDetails();
        });

    const key = d3.select("#lt_chart_key")
        .append("div")
        .attr("id", "key")
        .style("display", "flex")
        .style("flex-direction", "column")
        .style("margin-left", "20px")
        .style("margin-top", "20px");

    key.selectAll("div")
        .data(statsData)
        .enter()
        .append("div")
        .style("display", "flex")
        .style("align-items", "center")
        .style("margin-bottom", "5px")
        .html(function(d) {
            return `
                <div style="width: 12px; height: 12px; background-color: ${d.color}; 
                    margin-right: 8px; border: 1px solid black;"></div>
                ${d.label}
            `;
    });

    window.addEventListener("resize", function () {
        pieWidth = Math.max(window.innerWidth * 0.2, 230);
        pieHeight = Math.max(window.innerWidth * 0.2, 230);
        pieRadius = Math.max(pieWidth, pieHeight) / 2 - pieMargin;

        d3.select("svg")
            .attr("width", pieWidth)
            .attr("height", pieHeight);

        svg.attr("transform", "translate(" + pieWidth / 2 + "," + pieHeight / 2 + ")");
        arc.outerRadius(pieRadius);
        svg.selectAll("path").attr("d", arc);
    });
    
    //percentage of time displayed when the user hovers over the pie chart
    function displayDetails(d) {
        var percentage = @totalTime > 0 ? ((d.time / @totalTime) * 100).toFixed(2) : 0;
        let detailsDiv = d3.select("#lt_chart_details");
        detailsDiv.html(`<strong>${d.label}</strong>: (${percentage}%)`);
        detailsDiv.style("display", "block");
    }

    function hideDetails() {
        d3.select("#lt_chart_details").style("display", "none");
    }

</script>












